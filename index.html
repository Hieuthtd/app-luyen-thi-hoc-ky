<!doctype html>
<html lang="vi">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ph·∫ßn m·ªÅm √¥n luy·ªán thi h·ªçc k·ª≥</title>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #FF6B9D 0%, #C06C84 50%, #6C5B7B 100%);
      min-height: 100vh;
    }
    
    * {
      box-sizing: border-box;
    }
    
    .app-container {
      width: 100%;
      height: 100%;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 20px;
    }
    
    .header {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header h1 {
      margin: 0;
      color: #27ae60;
      font-size: 24px;
      font-weight: 900;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .user-info {
      text-align: right;
    }
    
    .user-info p {
      margin: 5px 0;
      color: #333;
      font-size: 14px;
    }
    
    .btn {
      padding: 10px 24px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 700;
      transition: all 0.3s;
      background: #667eea;
      color: white;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      background: #e74c3c;
    }
    
    .btn-secondary:hover {
      background: #c0392b;
    }
    
    .btn-success {
      background: #27ae60;
    }
    
    .btn-success:hover {
      background: #229954;
    }
    
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
    }
    
    .login-container h2 {
      text-align: center;
      color: #27ae60;
      margin-bottom: 30px;
      font-size: 28px;
      font-weight: 900;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.15);
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
      font-size: 14px;
    }
    
    .form-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .subject-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .subject-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 30px;
      border-radius: 16px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
      border: 3px solid rgba(255, 255, 255, 0.3);
    }
    
    .subject-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.25);
      border-color: rgba(255, 255, 255, 0.5);
    }
    
    .subject-card h3 {
      margin: 0;
      color: white;
      font-size: 18px;
      font-weight: 800;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }
    
    .subject-card .count {
      margin-top: 10px;
      font-size: 14px;
      opacity: 0.9;
    }
    
    .welcome-message {
      background: white;
      padding: 30px;
      border-radius: 12px;
      text-align: center;
      margin: 20px 0;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .welcome-message h2 {
      color: #f39c12;
      margin-bottom: 20px;
      font-size: 22px;
      font-weight: 900;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .exam-container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .timer-bar {
      background: #e0e0e0;
      height: 30px;
      border-radius: 15px;
      margin-bottom: 20px;
      overflow: hidden;
      position: relative;
    }
    
    .timer-progress {
      background: linear-gradient(90deg, #27ae60, #229954);
      height: 100%;
      transition: width 1s linear;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    .question-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 10px;
      margin-bottom: 30px;
    }
    
    .question-number {
      padding: 15px;
      background: #f0f0f0;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .question-number:hover {
      background: #e0e0e0;
    }
    
    .question-number.answered {
      background: #f39c12;
      color: white;
    }
    
    .question-number.correct {
      background: #27ae60;
      color: white;
    }
    
    .question-number.incorrect {
      background: #e74c3c;
      color: white;
    }
    
    .question-display {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .question-display h3 {
      color: #333;
      margin-bottom: 20px;
      font-size: 20px;
    }
    
    .answer-option {
      background: white;
      padding: 15px;
      margin-bottom: 12px;
      border-radius: 8px;
      cursor: pointer;
      border: 2px solid #e0e0e0;
      transition: all 0.3s;
    }
    
    .answer-option:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }
    
    .answer-option.selected {
      border-color: #667eea;
      background: #e8eeff;
    }
    
    .navigation-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
      gap: 10px;
    }
    
    .result-container {
      background: white;
      padding: 40px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      text-align: center;
    }
    
    .result-container h2 {
      color: #667eea;
      margin-bottom: 30px;
      font-size: 28px;
    }
    
    .result-info {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: left;
    }
    
    .result-info p {
      margin: 10px 0;
      font-size: 18px;
      color: #333;
    }
    
    .result-status {
      font-size: 32px;
      font-weight: bold;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    
    .result-status.pass {
      background: #d4edda;
      color: #27ae60;
    }
    
    .result-status.fail {
      background: #f8d7da;
      color: #e74c3c;
    }
    
    .admin-form {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 12px;
      margin-top: 20px;
    }
    
    .admin-form h3 {
      color: #667eea;
      margin-bottom: 20px;
      font-size: 22px;
    }
    
    .admin-form textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
    }
    
    .answer-inputs {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin: 20px 0;
    }
    
    .radio-group {
      margin: 20px 0;
    }
    
    .radio-option {
      display: flex;
      align-items: center;
      margin: 10px 0;
    }
    
    .radio-option input[type="radio"] {
      margin-right: 10px;
      width: 20px;
      height: 20px;
    }
    
    .radio-option label {
      font-size: 16px;
      color: #333;
    }
    
    .action-buttons {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }
    
    .hidden {
      display: none !important;
    }
    
    .content-area {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .loading-spinner {
      text-align: center;
      padding: 20px;
      color: #667eea;
      font-size: 18px;
    }
    
    .admin-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      color: white;
      font-weight: 700;
    }
    
    .admin-btn:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
      border-color: rgba(255, 255, 255, 0.5);
    }
    
    .admin-btn.selected {
      background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
      border-color: rgba(255, 255, 255, 0.6);
    }

    .admin-selector {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .admin-selector h3 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .admin-selector select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      background: white;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="app-container" id="appContainer"><!-- Student Login Screen -->
   <div id="studentLoginScreen" class="login-container">
    <h2 id="appTitle">PH·∫¶N M·ªÄM √îN LUY·ªÜN THI H·ªåC K·ª≤</h2>
    <form id="studentLoginForm" onsubmit="handleStudentLogin(event)">
     <div class="form-group"><label for="studentName">H·ªç v√† t√™n h·ªçc sinh</label> <input type="text" id="studentName" required>
     </div>
     <div class="form-group"><label for="studentClass">L·ªõp</label> <input type="text" id="studentClass" required>
     </div>
     <div class="form-group"><label for="selectAdmin">Ch·ªçn qu·∫£n tr·ªã vi√™n</label> <select id="selectAdmin" required> <option value="">-- Ch·ªçn qu·∫£n tr·ªã vi√™n --</option> <option value="admin_main">Qu·∫£n tr·ªã vi√™n ch√≠nh</option> <option value="admin_2">Qu·∫£n tr·ªã vi√™n 2</option> <option value="admin_3">Qu·∫£n tr·ªã vi√™n 3</option> <option value="admin_4">Qu·∫£n tr·ªã vi√™n 4</option> <option value="admin_5">Qu·∫£n tr·ªã vi√™n 5</option> <option value="admin_6">Qu·∫£n tr·ªã vi√™n 6</option> </select>
     </div><button type="submit" class="btn" style="width: 100%; border: none;">ƒêƒÉng nh·∫≠p</button>
    </form>
    <div style="text-align: center; margin-top: 20px;"><button type="button" class="btn btn-secondary" onclick="showAdminLogin()" style="border: none;">ƒêƒÉng nh·∫≠p qu·∫£n tr·ªã vi√™n</button>
    </div>
   </div><!-- Admin Login Screen -->
   <div id="adminLoginScreen" class="login-container hidden">
    <h2>ƒêƒÉng nh·∫≠p qu·∫£n tr·ªã vi√™n</h2><!-- Main Admin Login -->
    <div id="mainAdminLogin">
     <form onsubmit="handleMainAdminLogin(event)">
      <div class="form-group"><label for="mainAdminName">H·ªç v√† t√™n qu·∫£n tr·ªã vi√™n ch√≠nh</label> <input type="text" id="mainAdminName" placeholder="VD: L√™ VƒÉn A" required>
      </div>
      <div class="form-group"><label for="mainAdminPassword">M·∫≠t kh·∫©u</label> <input type="password" id="mainAdminPassword" required>
      </div><button type="submit" class="btn" style="width: 100%; border: none;">ƒêƒÉng nh·∫≠p</button>
     </form>
     <div style="text-align: center; margin-top: 20px;"><button type="button" class="btn" onclick="showSubAdminSelection()" style="border: none; background: #9ca3af;">Qu·∫£n tr·ªã vi√™n ph·ª•</button>
     </div>
    </div><!-- Sub Admin Selection -->
    <div id="subAdminSelection" class="hidden">
     <div style="margin-bottom: 20px;">
      <p style="text-align: center; color: #666; font-size: 14px;">Ch·ªçn qu·∫£n tr·ªã vi√™n ph·ª• (c·∫ßn ƒë∆∞·ª£c c·∫•p quy·ªÅn)</p>
     </div>
     <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;"><button type="button" class="admin-btn" onclick="selectSubAdmin(2)" data-admin="2"> <h4 style="margin: 0; font-size: 16px;">Qu·∫£n tr·ªã vi√™n 2</h4><p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.8;" id="status-2">üîí Ch∆∞a c·∫•p quy·ªÅn</p></button> <button type="button" class="admin-btn" onclick="selectSubAdmin(3)" data-admin="3"> <h4 style="margin: 0; font-size: 16px;">Qu·∫£n tr·ªã vi√™n 3</h4><p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.8;" id="status-3">üîí Ch∆∞a c·∫•p quy·ªÅn</p></button> <button type="button" class="admin-btn" onclick="selectSubAdmin(4)" data-admin="4"> <h4 style="margin: 0; font-size: 16px;">Qu·∫£n tr·ªã vi√™n 4</h4><p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.8;" id="status-4">üîí Ch∆∞a c·∫•p quy·ªÅn</p></button> <button type="button" class="admin-btn" onclick="selectSubAdmin(5)" data-admin="5"> <h4 style="margin: 0; font-size: 16px;">Qu·∫£n tr·ªã vi√™n 5</h4><p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.8;" id="status-5">üîí Ch∆∞a c·∫•p quy·ªÅn</p></button> <button type="button" class="admin-btn" onclick="selectSubAdmin(6)" data-admin="6"> <h4 style="margin: 0; font-size: 16px;">Qu·∫£n tr·ªã vi√™n 6</h4><p style="margin: 5px 0 0 0; font-size: 12px; opacity: 0.8;" id="status-6">üîí Ch∆∞a c·∫•p quy·ªÅn</p></button>
     </div>
     <form id="subAdminLoginForm" onsubmit="handleSubAdminLogin(event)" class="hidden">
      <div class="form-group"><label for="subAdminName">ƒêƒÉng nh·∫≠p: <span id="selectedSubAdminName" style="color: #667eea; font-weight: bold;"></span></label> <input type="hidden" id="subAdminName" required>
      </div>
      <div class="form-group"><label for="subAdminPassword">M·∫≠t kh·∫©u</label> <input type="password" id="subAdminPassword" required>
      </div>
      <div style="display: flex; gap: 10px;"><button type="button" class="btn btn-secondary" onclick="backToSubAdminSelection()" style="flex: 1; border: none;">Quay l·∫°i</button> <button type="submit" class="btn" style="flex: 1; border: none;">ƒêƒÉng nh·∫≠p</button>
      </div>
     </form>
     <div style="text-align: center; margin-top: 20px;"><button type="button" class="btn btn-secondary" onclick="showMainAdminLogin()" style="border: none;">Qu·∫£n tr·ªã vi√™n ch√≠nh</button>
     </div>
    </div>
    <div style="text-align: center; margin-top: 20px;"><button type="button" class="btn btn-secondary" onclick="showStudentLogin()" style="border: none;">ƒêƒÉng nh·∫≠p h·ªçc sinh</button>
    </div>
   </div><!-- Student Subject Selection -->
   <div id="studentDashboard" class="hidden">
    <div class="header">
     <h1 id="dashboardTitle">PH·∫¶N M·ªÄM √îN LUY·ªÜN THI H·ªåC K·ª≤</h1>
     <div class="user-info">
      <p><strong>H·ªç v√† T√™n:</strong> <span id="displayStudentName"></span></p>
      <p><strong>L·ªõp:</strong> <span id="displayStudentClass"></span></p>
      <p><strong>QTV:</strong> <span id="displayStudentAdmin"></span></p><button class="btn btn-secondary" onclick="logout()">ƒêƒÉng xu·∫•t</button>
     </div>
    </div>
    <div class="content-area">
     <div class="subject-grid" id="studentSubjectGrid"></div>
     <div id="welcomeMessage" class="welcome-message hidden">
      <h2 id="welcomeText"></h2><button class="btn btn-success" onclick="startExam()">B·∫Øt ƒë·∫ßu</button>
     </div>
    </div>
   </div><!-- Exam Screen -->
   <div id="examScreen" class="hidden">
    <div class="header">
     <h1 id="examTitle">PH·∫¶N M·ªÄM √îN LUY·ªÜN THI H·ªåC K·ª≤</h1>
     <div class="user-info">
      <p><strong>H·ªç v√† T√™n:</strong> <span id="examStudentName"></span></p>
      <p><strong>L·ªõp:</strong> <span id="examStudentClass"></span></p><button class="btn btn-secondary" onclick="logout()">ƒêƒÉng xu·∫•t</button>
     </div>
    </div>
    <div class="content-area">
     <div class="exam-container">
      <div class="timer-bar">
       <div class="timer-progress" id="timerProgress">
        20:00
       </div>
      </div>
      <div class="question-grid" id="questionGrid"></div>
      <div class="question-display">
       <h3 id="currentQuestion">C√¢u h·ªèi s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</h3>
       <div id="answerOptions"></div>
      </div>
      <div class="navigation-buttons"><button class="btn" onclick="previousQuestion()">C√¢u tr∆∞·ªõc</button> <button class="btn btn-secondary" onclick="finishExam()">K·∫øt th√∫c b√†i</button> <button class="btn" onclick="nextQuestion()">C√¢u sau</button>
      </div>
     </div>
    </div>
   </div><!-- Result Screen -->
   <div id="resultScreen" class="hidden">
    <div class="header">
     <h1 id="resultTitle">PH·∫¶N M·ªÄM √îN LUY·ªÜN THI H·ªåC K·ª≤</h1>
     <div class="user-info"><button class="btn btn-secondary" onclick="logout()">ƒêƒÉng xu·∫•t</button>
     </div>
    </div>
    <div class="content-area">
     <div class="result-container">
      <h2 id="resultSubjectTitle">K·∫æT QU·∫¢ B√ÄI THI</h2>
      <div class="result-info">
       <p><strong>H·ªç v√† t√™n:</strong> <span id="resultStudentName"></span></p>
       <p><strong>Th·ªùi gian l√†m b√†i:</strong> <span id="resultTime"></span></p>
       <p><strong>T·ªïng ƒëi·ªÉm:</strong> <span id="resultScore"></span>/30</p>
      </div>
      <div id="resultStatus" class="result-status"></div>
      <div class="question-grid" id="resultQuestionGrid"></div>
      <div class="question-display hidden" id="reviewQuestion">
       <h3 id="reviewQuestionText"></h3>
       <div id="reviewAnswerOptions"></div>
      </div><button class="btn btn-success" onclick="retakeExam()" style="margin-top: 20px;">L√†m l·∫°i</button>
     </div>
    </div>
   </div><!-- Admin Dashboard -->
   <div id="adminDashboard" class="hidden">
    <div class="header">
     <h1 id="adminDashboardTitle">PH·∫¶N M·ªÄM √îN LUY·ªÜN THI H·ªåC K·ª≤</h1>
     <div class="user-info">
      <p><strong>Qu·∫£n tr·ªã vi√™n:</strong> <span id="displayAdminName"></span></p><button class="btn btn-secondary" onclick="logout()">ƒêƒÉng xu·∫•t</button>
     </div>
    </div>
    <div class="content-area"><!-- Permission Management (Only for Main Admin) -->
     <div id="permissionManagement" class="admin-form hidden" style="margin-bottom: 20px;">
      <h3 style="color: #e74c3c;">üîê Qu·∫£n l√Ω quy·ªÅn truy c·∫≠p</h3>
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
       <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #e0e0e0;">
        <h4 style="margin: 0 0 10px 0; color: #667eea;">Qu·∫£n tr·ªã vi√™n 2</h4>
        <div class="form-group"><label for="pass2">M·∫≠t kh·∫©u m·ªõi:</label> <input type="text" id="pass2" placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
        </div><button class="btn btn-success" onclick="grantAccess(2)" style="width: 100%; border: none;">C·∫•p quy·ªÅn</button>
       </div>
       <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #e0e0e0;">
        <h4 style="margin: 0 0 10px 0; color: #667eea;">Qu·∫£n tr·ªã vi√™n 3</h4>
        <div class="form-group"><label for="pass3">M·∫≠t kh·∫©u m·ªõi:</label> <input type="text" id="pass3" placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
        </div><button class="btn btn-success" onclick="grantAccess(3)" style="width: 100%; border: none;">C·∫•p quy·ªÅn</button>
       </div>
       <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #e0e0e0;">
        <h4 style="margin: 0 0 10px 0; color: #667eea;">Qu·∫£n tr·ªã vi√™n 4</h4>
        <div class="form-group"><label for="pass4">M·∫≠t kh·∫©u m·ªõi:</label> <input type="text" id="pass4" placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
        </div><button class="btn btn-success" onclick="grantAccess(4)" style="width: 100%; border: none;">C·∫•p quy·ªÅn</button>
       </div>
       <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #e0e0e0;">
        <h4 style="margin: 0 0 10px 0; color: #667eea;">Qu·∫£n tr·ªã vi√™n 5</h4>
        <div class="form-group"><label for="pass5">M·∫≠t kh·∫©u m·ªõi:</label> <input type="text" id="pass5" placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
        </div><button class="btn btn-success" onclick="grantAccess(5)" style="width: 100%; border: none;">C·∫•p quy·ªÅn</button>
       </div>
       <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #e0e0e0;">
        <h4 style="margin: 0 0 10px 0; color: #667eea;">Qu·∫£n tr·ªã vi√™n 6</h4>
        <div class="form-group"><label for="pass6">M·∫≠t kh·∫©u m·ªõi:</label> <input type="text" id="pass6" placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
        </div><button class="btn btn-success" onclick="grantAccess(6)" style="width: 100%; border: none;">C·∫•p quy·ªÅn</button>
       </div>
      </div>
     </div>
     <div class="subject-grid" id="adminSubjectGrid"></div>
     <div id="adminForm" class="admin-form hidden">
      <h3>Th√™m c√¢u h·ªèi cho m√¥n: <span id="currentSubject"></span></h3>
      <div style="margin-bottom: 20px; display: flex; gap: 10px;"><button type="button" class="btn" onclick="showSingleMode()" id="btnSingleMode">Nh·∫≠p t·ª´ng c√¢u</button> <button type="button" class="btn" onclick="showBulkMode()" id="btnBulkMode">Nh·∫≠p nhi·ªÅu c√¢u</button> <button type="button" class="btn btn-secondary" onclick="showDeleteMode()" id="btnDeleteMode">X√≥a c√¢u h·ªèi</button>
      </div><!-- Single Question Form -->
      <form id="questionForm" onsubmit="saveQuestion(event)">
       <div class="form-group"><label>C√¢u h·ªèi</label> <textarea id="questionText" required></textarea>
       </div>
       <div class="answer-inputs">
        <div class="form-group"><label for="answerA">ƒê√°p √°n A:</label> <input type="text" id="answerA" required>
        </div>
        <div class="form-group"><label for="answerB">ƒê√°p √°n B:</label> <input type="text" id="answerB" required>
        </div>
        <div class="form-group"><label for="answerC">ƒê√°p √°n C:</label> <input type="text" id="answerC" required>
        </div>
        <div class="form-group"><label for="answerD">ƒê√°p √°n D:</label> <input type="text" id="answerD" required>
        </div>
       </div>
       <div class="radio-group">
        <p><strong>Ch·ªçn ƒë√°p √°n ƒë√∫ng:</strong></p>
        <div class="radio-option"><input type="radio" id="correctA" name="correctAnswer" value="A" required> <label for="correctA">A</label>
        </div>
        <div class="radio-option"><input type="radio" id="correctB" name="correctAnswer" value="B"> <label for="correctB">B</label>
        </div>
        <div class="radio-option"><input type="radio" id="correctC" name="correctAnswer" value="C"> <label for="correctC">C</label>
        </div>
        <div class="radio-option"><input type="radio" id="correctD" name="correctAnswer" value="D"> <label for="correctD">D</label>
        </div>
       </div>
       <div class="action-buttons"><button type="submit" class="btn btn-success" style="border: none;">L∆∞u</button> <button type="button" class="btn btn-secondary" onclick="clearForm()" style="border: none;">X√≥a</button>
       </div>
      </form><!-- Bulk Question Form -->
      <form id="bulkQuestionForm" onsubmit="saveBulkQuestions(event)" class="hidden">
       <div class="form-group"><label>Nh·∫≠p nhi·ªÅu c√¢u h·ªèi (ƒê√°p √°n ƒë√∫ng c√≥ d·∫•u = ·ªü ƒë·∫ßu)</label>
        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 10px; font-size: 14px;"><strong>V√≠ d·ª• ƒë·ªãnh d·∫°ng:</strong><br>
          Qu·ªëc ca Vi·ªát Nam l√† b√†i h√°t n√†o?<br>
          A. = Ti·∫øn qu√¢n ca.<br>
          B. M·ªôt v√≤ng Vi·ªát Nam.<br>
          C. Vi·ªát Nam ∆°i.<br>
          D. Xin ch√†o Vi·ªát Nam<br>
          Ai l√† ng∆∞·ªùi s√°ng t√°c qu·ªëc ca?<br>
          A. T·ªë H·ªØu<br>
          B. V√µ Nguy√™n Gi√°p<br>
          C. =VƒÉn Cao<br>
          D. Tr·∫ßn Ti·∫øn
        </div><textarea id="bulkQuestionText" rows="20" required style="font-family: monospace;"></textarea>
       </div>
       <div class="action-buttons"><button type="submit" class="btn btn-success" style="border: none;">L∆∞u t·∫•t c·∫£</button> <button type="button" class="btn btn-secondary" onclick="clearBulkForm()" style="border: none;">X√≥a</button>
       </div>
      </form><!-- Delete Question Mode -->
      <div id="deleteQuestionMode" class="hidden">
       <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 2px solid #ffc107;">
        <p style="margin: 0; color: #856404; font-weight: 600;">‚ö†Ô∏è B·∫°n ƒëang ·ªü ch·∫ø ƒë·ªô x√≥a c√¢u h·ªèi. Nh·∫•n v√†o c√¢u h·ªèi ƒë·ªÉ x√≥a.</p>
       </div>
       <div id="questionListContainer" style="max-height: 500px; overflow-y: auto;"><!-- Questions will be loaded here -->
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      app_title: "PH·∫¶N M·ªÄM √îN LUY·ªÜN THI H·ªåC K·ª≤",
      welcome_prefix: "CH√ÄO M·ª™NG B·∫†N ƒê√É ƒê·∫æN V·ªöI PH·∫¶N THI",
      background_color: "#FF6B9D",
      card_color: "#ffffff",
      text_color: "#333333",
      primary_button_color: "#667eea",
      secondary_button_color: "#e74c3c",
      font_family: "Segoe UI",
      font_size: 16
    };

    let currentUser = null;
    let currentAdminId = null;
    let isAdmin = false;
    let isMainAdmin = false;
    let selectedSubject = null;
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let examQuestions = [];
    let examStartTime = null;
    let timerInterval = null;
    let timeRemaining = 1200;
    let examFinished = false;
    let allQuestions = [];
    let subAdminPasswords = {};
    let permissionsLoaded = false;

    const SUBJECTS = ['To√°n', 'L·ªãch s·ª≠ v√† ƒê·ªãa l√≠', 'Ti·∫øng Vi·ªát', 'Khoa h·ªçc', 'C√¥ng ngh·ªá', 'Ti·∫øng Anh', 'Tin h·ªçc'];

    // Load questions from Trickle Database
    async function loadQuestionsFromDB() {
      try {
        const result = await trickleListObjects('question', 1000, true);
        if (result && result.items) {
          allQuestions = result.items.map(item => ({
            id: item.objectId,
            admin_id: item.objectData.admin_id,
            subject: item.objectData.subject,
            question: item.objectData.question,
            answer_a: item.objectData.answer_a,
            answer_b: item.objectData.answer_b,
            answer_c: item.objectData.answer_c,
            answer_d: item.objectData.answer_d,
            correct_answer: item.objectData.correct_answer,
            created_at: item.createdAt
          }));
        }
      } catch (error) {
        console.error('Error loading questions:', error);
      }
    }

    // Load admin permissions from Trickle Database
    async function loadPermissionsFromDB() {
      try {
        const result = await trickleListObjects('admin_permission', 20, true);
        if (result && result.items) {
          result.items.forEach(item => {
            const adminNum = item.objectData.admin_number;
            if (item.objectData.is_active) {
              subAdminPasswords[adminNum] = item.objectData.password;
            }
          });
        }
        permissionsLoaded = true;
      } catch (error) {
        console.error('Error loading permissions:', error);
      }
    }

    function getAdminName(adminId) {
      if (adminId === 'admin_main') return 'Qu·∫£n tr·ªã vi√™n ch√≠nh';
      const num = adminId.replace('admin_', '');
      return `Qu·∫£n tr·ªã vi√™n ${num}`;
    }

    async function updateSubjectCounts() {
      await loadQuestionsFromDB();
      
      // Update student subject grid
      const studentGrid = document.getElementById('studentSubjectGrid');
      if (studentGrid && currentAdminId && !isAdmin) {
        studentGrid.innerHTML = '';
        SUBJECTS.forEach(subject => {
          const count = allQuestions.filter(q => q.admin_id === currentAdminId && q.subject === subject).length;
          const card = document.createElement('div');
          card.className = 'subject-card';
          card.onclick = () => selectSubject(subject);
          card.innerHTML = `
            <h3>${subject.toUpperCase()}</h3>
            <div class="count">${count} c√¢u h·ªèi</div>
          `;
          studentGrid.appendChild(card);
        });
      }

      // Update admin subject grid
      const adminGrid = document.getElementById('adminSubjectGrid');
      if (adminGrid && currentAdminId && isAdmin) {
        adminGrid.innerHTML = '';
        SUBJECTS.forEach(subject => {
          const count = allQuestions.filter(q => q.admin_id === currentAdminId && q.subject === subject).length;
          const card = document.createElement('div');
          card.className = 'subject-card';
          card.onclick = () => manageSubject(subject);
          card.innerHTML = `
            <h3>${subject.toUpperCase()}</h3>
            <div class="count">${count} c√¢u h·ªèi</div>
          `;
          adminGrid.appendChild(card);
        });
      }
    }

    function onConfigChange(config) {
      const customFont = config.font_family || defaultConfig.font_family;
      const baseSize = config.font_size || defaultConfig.font_size;
      const backgroundColor = config.background_color || defaultConfig.background_color;
      const cardColor = config.card_color || defaultConfig.card_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryButtonColor = config.primary_button_color || defaultConfig.primary_button_color;
      const secondaryButtonColor = config.secondary_button_color || defaultConfig.secondary_button_color;
      const appTitle = config.app_title || defaultConfig.app_title;
      const welcomePrefix = config.welcome_prefix || defaultConfig.welcome_prefix;

      document.body.style.fontFamily = `${customFont}, Arial, sans-serif`;
      document.body.style.background = `linear-gradient(135deg, ${backgroundColor} 0%, #C06C84 50%, #6C5B7B 100%)`;

      const headerTitles = document.querySelectorAll('.header h1');
      headerTitles.forEach(h => {
        h.style.fontSize = `${baseSize * 1.5}px`;
        h.style.color = '#FFD700';
        h.style.fontWeight = '900';
        h.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.3)';
        h.textContent = appTitle;
      });

      const loginTitles = document.querySelectorAll('.login-container h2');
      loginTitles.forEach(title => {
        title.style.fontSize = `${baseSize * 1.75}px`;
        title.style.color = '#FFD700';
        title.style.fontWeight = '900';
        title.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.3)';
      });

      const appTitleElement = document.getElementById('appTitle');
      if (appTitleElement) {
        appTitleElement.textContent = appTitle;
        appTitleElement.style.color = '#FFD700';
      }

      const whiteCards = document.querySelectorAll('.subject-card, .login-container, .exam-container, .result-container, .admin-form, .welcome-message');
      whiteCards.forEach(card => {
        card.style.backgroundColor = cardColor;
      });
      
      const headers = document.querySelectorAll('.header');
      headers.forEach(header => {
        header.style.background = 'linear-gradient(135deg, #1E90FF 0%, #4169E1 100%)';
      });

      const allText = document.querySelectorAll('p, label, h3, .user-info p, .result-info p');
      allText.forEach(text => {
        text.style.color = textColor;
        text.style.fontSize = `${baseSize}px`;
      });

      const primaryButtons = document.querySelectorAll('.btn:not(.btn-secondary):not(.btn-success)');
      primaryButtons.forEach(btn => {
        btn.style.backgroundColor = primaryButtonColor;
        btn.style.fontSize = `${baseSize}px`;
        btn.style.fontWeight = '700';
        btn.style.border = '3px solid rgba(255, 255, 255, 0.3)';
        btn.style.borderRadius = '12px';
        btn.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.2)';
      });

      const secondaryButtons = document.querySelectorAll('.btn-secondary');
      secondaryButtons.forEach(btn => {
        btn.style.backgroundColor = secondaryButtonColor;
        btn.style.fontSize = `${baseSize}px`;
        btn.style.fontWeight = '700';
        btn.style.border = '3px solid rgba(255, 255, 255, 0.3)';
        btn.style.borderRadius = '12px';
        btn.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.2)';
      });

      const subjectCards = document.querySelectorAll('.subject-card');
      subjectCards.forEach(card => {
        card.style.background = `linear-gradient(135deg, ${primaryButtonColor} 0%, #764ba2 100%)`;
      });
      
      const subjectTitles = document.querySelectorAll('.subject-card h3');
      subjectTitles.forEach(title => {
        title.style.color = 'white';
        title.style.fontSize = `${baseSize * 1.125}px`;
        title.style.fontWeight = '800';
        title.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.3)';
      });

      if (selectedSubject) {
        const welcomeText = document.getElementById('welcomeText');
        if (welcomeText) {
          welcomeText.textContent = `${welcomePrefix} ${selectedSubject.toUpperCase()}.`;
          welcomeText.style.fontSize = `${baseSize * 1.375}px`;
          welcomeText.style.color = '#f39c12';
          welcomeText.style.fontWeight = '900';
          welcomeText.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.2)';
        }
      }
    }

    async function handleStudentLogin(event) {
      event.preventDefault();
      const name = document.getElementById('studentName').value;
      const studentClass = document.getElementById('studentClass').value;
      const adminId = document.getElementById('selectAdmin').value;
      
      currentUser = { name, class: studentClass };
      currentAdminId = adminId;
      isAdmin = false;
      
      showScreen('studentDashboard');
      document.getElementById('displayStudentName').textContent = name;
      document.getElementById('displayStudentClass').textContent = studentClass;
      document.getElementById('displayStudentAdmin').textContent = getAdminName(adminId);
      
      await updateSubjectCounts();
    }

    async function handleMainAdminLogin(event) {
      event.preventDefault();
      const name = document.getElementById('mainAdminName').value.trim();
      const password = document.getElementById('mainAdminPassword').value;
      
      if (password !== '1q2w3e4r5t6y') {
        const errorDiv = document.createElement('div');
        errorDiv.style.color = '#e74c3c';
        errorDiv.style.textAlign = 'center';
        errorDiv.style.marginTop = '10px';
        errorDiv.textContent = 'M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!';
        const form = event.target;
        const existingError = form.querySelector('div[style*="color"]');
        if (existingError) existingError.remove();
        form.appendChild(errorDiv);
        return;
      }
      
      currentUser = { name };
      currentAdminId = 'admin_main';
      isAdmin = true;
      isMainAdmin = true;
      
      if (!permissionsLoaded) {
        await loadPermissionsFromDB();
      }
      
      showScreen('adminDashboard');
      document.getElementById('displayAdminName').textContent = name;
      document.getElementById('permissionManagement').classList.remove('hidden');
      
      await updateSubjectCounts();
      
      // Update permission display
      for (let i = 2; i <= 6; i++) {
        const statusEl = document.getElementById(`status-${i}`);
        if (subAdminPasswords[i]) {
          statusEl.textContent = '‚úÖ ƒê√£ c·∫•p quy·ªÅn';
          statusEl.style.color = '#27ae60';
        }
      }
    }
    
    async function showSubAdminSelection() {
      document.getElementById('mainAdminLogin').classList.add('hidden');
      document.getElementById('subAdminSelection').classList.remove('hidden');
      
      if (!permissionsLoaded) {
        await loadPermissionsFromDB();
      }
      
      // Update status for each sub admin
      for (let i = 2; i <= 6; i++) {
        const statusEl = document.getElementById(`status-${i}`);
        if (subAdminPasswords[i]) {
          statusEl.textContent = '‚úÖ ƒê√£ c·∫•p quy·ªÅn';
          statusEl.style.color = '#27ae60';
        } else {
          statusEl.textContent = 'üîí Ch∆∞a c·∫•p quy·ªÅn';
          statusEl.style.color = 'white';
        }
      }
    }
    
    function showMainAdminLogin() {
      document.getElementById('mainAdminLogin').classList.remove('hidden');
      document.getElementById('subAdminSelection').classList.add('hidden');
      document.getElementById('subAdminLoginForm').classList.add('hidden');
      
      const allButtons = document.querySelectorAll('.admin-btn');
      allButtons.forEach(btn => btn.classList.remove('selected'));
    }
    
    function selectSubAdmin(adminNumber) {
      if (!subAdminPasswords[adminNumber]) {
        const messageDiv = document.createElement('div');
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.color = '#721c24';
        messageDiv.style.padding = '15px';
        messageDiv.style.borderRadius = '8px';
        messageDiv.style.marginTop = '10px';
        messageDiv.style.textAlign = 'center';
        messageDiv.textContent = 'Qu·∫£n tr·ªã vi√™n n√†y ch∆∞a ƒë∆∞·ª£c c·∫•p quy·ªÅn!';
        
        const container = document.getElementById('subAdminSelection');
        const existingMsg = container.querySelector('div[style*="background: #f8d7da"]');
        if (existingMsg) existingMsg.remove();
        container.insertBefore(messageDiv, container.firstChild);
        
        setTimeout(() => messageDiv.remove(), 3000);
        return;
      }
      
      const allButtons = document.querySelectorAll('.admin-btn');
      allButtons.forEach(btn => btn.classList.remove('selected'));
      
      const selectedButton = document.querySelector(`.admin-btn[data-admin="${adminNumber}"]`);
      selectedButton.classList.add('selected');
      
      const adminName = `Qu·∫£n tr·ªã vi√™n ${adminNumber}`;
      document.getElementById('subAdminName').value = adminName;
      document.getElementById('selectedSubAdminName').textContent = adminName;
      
      document.getElementById('subAdminLoginForm').classList.remove('hidden');
      document.getElementById('subAdminPassword').focus();
    }
    
    function backToSubAdminSelection() {
      document.getElementById('subAdminLoginForm').classList.add('hidden');
      document.getElementById('subAdminPassword').value = '';
      
      const form = document.getElementById('subAdminLoginForm');
      const existingError = form.querySelector('div[style*="color"]');
      if (existingError) existingError.remove();
      
      const allButtons = document.querySelectorAll('.admin-btn');
      allButtons.forEach(btn => btn.classList.remove('selected'));
    }

    async function handleSubAdminLogin(event) {
      event.preventDefault();
      const name = document.getElementById('subAdminName').value;
      const password = document.getElementById('subAdminPassword').value;
      
      const adminNumber = parseInt(name.match(/\d+/)[0]);
      const correctPassword = subAdminPasswords[adminNumber];
      
      if (password !== correctPassword) {
        const errorDiv = document.createElement('div');
        errorDiv.style.color = '#e74c3c';
        errorDiv.style.textAlign = 'center';
        errorDiv.style.marginTop = '10px';
        errorDiv.textContent = 'M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!';
        const form = document.getElementById('subAdminLoginForm');
        const existingError = form.querySelector('div[style*="color"]');
        if (existingError) existingError.remove();
        form.appendChild(errorDiv);
        return;
      }
      
      currentUser = { name };
      currentAdminId = `admin_${adminNumber}`;
      isAdmin = true;
      isMainAdmin = false;
      
      showScreen('adminDashboard');
      document.getElementById('displayAdminName').textContent = name;
      document.getElementById('permissionManagement').classList.add('hidden');
      
      await updateSubjectCounts();
    }
    
    async function grantAccess(adminNumber) {
      const password = document.getElementById(`pass${adminNumber}`).value.trim();
      
      if (!password) {
        const messageDiv = document.createElement('div');
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.color = '#721c24';
        messageDiv.style.padding = '10px';
        messageDiv.style.borderRadius = '8px';
        messageDiv.style.marginTop = '10px';
        messageDiv.style.textAlign = 'center';
        messageDiv.textContent = 'Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u!';
        
        const inputField = document.getElementById(`pass${adminNumber}`);
        const parent = inputField.closest('div[style*="background: white"]');
        const existingMsg = parent.querySelector('div[style*="background: #f8d7da"]');
        if (existingMsg) existingMsg.remove();
        parent.appendChild(messageDiv);
        
        setTimeout(() => messageDiv.remove(), 2000);
        return;
      }
      
      try {
        // Save to Trickle Database
        await trickleCreateObject('admin_permission', {
          admin_number: adminNumber,
          password: password,
          is_active: true
        });
        
        subAdminPasswords[adminNumber] = password;
        
        const messageDiv = document.createElement('div');
        messageDiv.style.background = '#d4edda';
        messageDiv.style.color = '#155724';
        messageDiv.style.padding = '10px';
        messageDiv.style.borderRadius = '8px';
        messageDiv.style.marginTop = '10px';
        messageDiv.style.textAlign = 'center';
        messageDiv.textContent = `ƒê√£ c·∫•p quy·ªÅn cho Qu·∫£n tr·ªã vi√™n ${adminNumber}!`;
        
        const inputField = document.getElementById(`pass${adminNumber}`);
        const parent = inputField.closest('div[style*="background: white"]');
        const existingMsg = parent.querySelector('div[style*="background"]');
        if (existingMsg) existingMsg.remove();
        parent.appendChild(messageDiv);
        
        document.getElementById(`pass${adminNumber}`).value = '';
        
        setTimeout(() => messageDiv.remove(), 3000);
      } catch (error) {
        console.error('Error granting access:', error);
        alert('C√≥ l·ªói x·∫£y ra khi c·∫•p quy·ªÅn!');
      }
    }

    function showAdminLogin() {
      showScreen('adminLoginScreen');
      document.getElementById('mainAdminLogin').classList.remove('hidden');
      document.getElementById('subAdminSelection').classList.add('hidden');
      document.getElementById('subAdminLoginForm').classList.add('hidden');
      document.getElementById('mainAdminName').value = '';
      document.getElementById('mainAdminPassword').value = '';
    }

    function showStudentLogin() {
      showScreen('studentLoginScreen');
    }

    function selectSubject(subject) {
      selectedSubject = subject;
      const welcomeMessage = document.getElementById('welcomeMessage');
      const welcomeText = document.getElementById('welcomeText');
      const welcomePrefix = defaultConfig.welcome_prefix;
      
      welcomeText.textContent = `${welcomePrefix} ${subject.toUpperCase()}.`;
      welcomeMessage.classList.remove('hidden');
    }

    function startExam() {
      const subjectQuestions = allQuestions.filter(q => q.admin_id === currentAdminId && q.subject === selectedSubject);
      
      if (subjectQuestions.length < 30) {
        const messageDiv = document.createElement('div');
        messageDiv.style.background = '#f8d7da';
        messageDiv.style.color = '#721c24';
        messageDiv.style.padding = '15px';
        messageDiv.style.borderRadius = '8px';
        messageDiv.style.marginTop = '20px';
        messageDiv.style.textAlign = 'center';
        messageDiv.textContent = `Ch∆∞a ƒë·ªß 30 c√¢u h·ªèi cho m√¥n n√†y. Hi·ªán c√≥ ${subjectQuestions.length} c√¢u.`;
        
        const welcomeMessage = document.getElementById('welcomeMessage');
        const existingMessage = welcomeMessage.querySelector('div[style*="background"]');
        if (existingMessage) existingMessage.remove();
        welcomeMessage.appendChild(messageDiv);
        return;
      }
      
      examQuestions = shuffleArray(subjectQuestions).slice(0, 30);
      userAnswers = new Array(30).fill(null);
      currentQuestionIndex = 0;
      examStartTime = new Date();
      timeRemaining = 1200;
      examFinished = false;
      
      showScreen('examScreen');
      document.getElementById('examStudentName').textContent = currentUser.name;
      document.getElementById('examStudentClass').textContent = currentUser.class;
      
      renderQuestionGrid();
      displayQuestion();
      startTimer();
    }

    function shuffleArray(array) {
      const shuffled = [...array];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    function renderQuestionGrid() {
      const grid = document.getElementById('questionGrid');
      grid.innerHTML = '';
      
      for (let i = 0; i < 30; i++) {
        const box = document.createElement('div');
        box.className = 'question-number';
        box.textContent = i + 1;
        box.onclick = () => jumpToQuestion(i);
        
        if (userAnswers[i] !== null) {
          box.classList.add('answered');
        }
        
        grid.appendChild(box);
      }
    }

    function displayQuestion() {
      const question = examQuestions[currentQuestionIndex];
      document.getElementById('currentQuestion').textContent = `C√¢u ${currentQuestionIndex + 1}: ${question.question}`;
      
      const optionsContainer = document.getElementById('answerOptions');
      optionsContainer.innerHTML = '';
      
      const answers = [
        { label: 'A', text: question.answer_a },
        { label: 'B', text: question.answer_b },
        { label: 'C', text: question.answer_c },
        { label: 'D', text: question.answer_d }
      ];
      
      answers.forEach(answer => {
        const option = document.createElement('div');
        option.className = 'answer-option';
        if (userAnswers[currentQuestionIndex] === answer.label) {
          option.classList.add('selected');
        }
        option.textContent = `${answer.label}. ${answer.text}`;
        
        if (!examFinished) {
          option.onclick = () => selectAnswer(answer.label);
        }
        
        optionsContainer.appendChild(option);
      });
    }

    function selectAnswer(answer) {
      if (examFinished) return;
      
      userAnswers[currentQuestionIndex] = answer;
      renderQuestionGrid();
      displayQuestion();
    }

    function previousQuestion() {
      if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        displayQuestion();
      }
    }

    function nextQuestion() {
      if (currentQuestionIndex < 29) {
        currentQuestionIndex++;
        displayQuestion();
      }
    }

    function jumpToQuestion(index) {
      currentQuestionIndex = index;
      displayQuestion();
    }

    function startTimer() {
      timerInterval = setInterval(() => {
        timeRemaining--;
        
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        const progress = document.getElementById('timerProgress');
        progress.textContent = timeString;
        progress.style.width = `${(timeRemaining / 1200) * 100}%`;
        
        if (timeRemaining <= 0) {
          finishExam();
        }
      }, 1000);
    }

    function finishExam() {
      if (examFinished) return;
      
      examFinished = true;
      clearInterval(timerInterval);
      
      const endTime = new Date();
      const timeSpent = Math.floor((endTime - examStartTime) / 1000);
      const minutes = Math.floor(timeSpent / 60);
      const seconds = timeSpent % 60;
      
      let correctCount = 0;
      examQuestions.forEach((question, index) => {
        if (userAnswers[index] === question.correct_answer) {
          correctCount++;
        }
      });
      
      showScreen('resultScreen');
      document.getElementById('resultSubjectTitle').textContent = `K·∫æT QU·∫¢ B√ÄI THI M√îN ${selectedSubject.toUpperCase()}`;
      document.getElementById('resultStudentName').textContent = currentUser.name;
      document.getElementById('resultTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      document.getElementById('resultScore').textContent = correctCount;
      
      const statusDiv = document.getElementById('resultStatus');
      if (correctCount >= 28) {
        statusDiv.textContent = 'ƒê·∫†T';
        statusDiv.className = 'result-status pass';
      } else {
        statusDiv.textContent = 'CH∆ØA ƒê·∫†T';
        statusDiv.className = 'result-status fail';
      }
      
      renderResultGrid();
    }

    function renderResultGrid() {
      const grid = document.getElementById('resultQuestionGrid');
      grid.innerHTML = '';
      
      for (let i = 0; i < 30; i++) {
        const box = document.createElement('div');
        box.className = 'question-number';
        box.textContent = i + 1;
        box.onclick = () => reviewQuestion(i);
        
        if (userAnswers[i] === examQuestions[i].correct_answer) {
          box.classList.add('correct');
        } else {
          box.classList.add('incorrect');
        }
        
        grid.appendChild(box);
      }
    }

    function reviewQuestion(index) {
      const question = examQuestions[index];
      const reviewDiv = document.getElementById('reviewQuestion');
      reviewDiv.classList.remove('hidden');
      
      document.getElementById('reviewQuestionText').textContent = `C√¢u ${index + 1}: ${question.question}`;
      
      const optionsContainer = document.getElementById('reviewAnswerOptions');
      optionsContainer.innerHTML = '';
      
      const answers = [
        { label: 'A', text: question.answer_a },
        { label: 'B', text: question.answer_b },
        { label: 'C', text: question.answer_c },
        { label: 'D', text: question.answer_d }
      ];
      
      answers.forEach(answer => {
        const option = document.createElement('div');
        option.className = 'answer-option';
        option.textContent = `${answer.label}. ${answer.text}`;
        
        if (answer.label === question.correct_answer) {
          option.style.background = '#d4edda';
          option.style.borderColor = '#27ae60';
        }
        
        if (answer.label === userAnswers[index] && userAnswers[index] !== question.correct_answer) {
          option.style.background = '#f8d7da';
          option.style.borderColor = '#e74c3c';
        }
        
        optionsContainer.appendChild(option);
      });
    }

    function retakeExam() {
      showScreen('studentDashboard');
      document.getElementById('welcomeMessage').classList.add('hidden');
    }

    function manageSubject(subject) {
      selectedSubject = subject;
      document.getElementById('currentSubject').textContent = subject;
      document.getElementById('adminForm').classList.remove('hidden');
    }

    async function saveQuestion(event) {
      event.preventDefault();
      
      const questionCount = allQuestions.filter(q => q.admin_id === currentAdminId && q.subject === selectedSubject).length;
      if (questionCount >= 999) {
        const errorDiv = document.createElement('div');
        errorDiv.style.background = '#f8d7da';
        errorDiv.style.color = '#721c24';
        errorDiv.style.padding = '15px';
        errorDiv.style.borderRadius = '8px';
        errorDiv.style.marginTop = '10px';
        errorDiv.textContent = 'ƒê√£ ƒë·∫°t gi·ªõi h·∫°n 999 c√¢u h·ªèi cho m√¥n n√†y!';
        
        const form = document.getElementById('questionForm');
        const existingError = form.querySelector('div[style*="background"]');
        if (existingError) existingError.remove();
        form.appendChild(errorDiv);
        return;
      }
      
      const submitButton = event.target.querySelector('button[type="submit"]');
      submitButton.disabled = true;
      submitButton.textContent = 'ƒêang l∆∞u...';
      
      try {
        const questionData = {
          admin_id: currentAdminId,
          subject: selectedSubject,
          question: document.getElementById('questionText').value,
          answer_a: document.getElementById('answerA').value,
          answer_b: document.getElementById('answerB').value,
          answer_c: document.getElementById('answerC').value,
          answer_d: document.getElementById('answerD').value,
          correct_answer: document.querySelector('input[name="correctAnswer"]:checked').value
        };
        
        // Save to Trickle Database
        await trickleCreateObject('question', questionData);
        
        submitButton.disabled = false;
        submitButton.textContent = 'L∆∞u';
        
        // Success message
        const successDiv = document.createElement('div');
        successDiv.style.background = '#d4edda';
        successDiv.style.color = '#155724';
        successDiv.style.padding = '15px';
        successDiv.style.borderRadius = '8px';
        successDiv.style.marginTop = '10px';
        successDiv.textContent = 'C√¢u h·ªèi ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng!';
        
        const form = document.getElementById('questionForm');
        const existingMessage = form.querySelector('div[style*="background"]');
        if (existingMessage) existingMessage.remove();
        form.appendChild(successDiv);
        
        clearForm();
        await updateSubjectCounts();
        setTimeout(() => successDiv.remove(), 3000);
      } catch (error) {
        console.error('Error saving question:', error);
        submitButton.disabled = false;
        submitButton.textContent = 'L∆∞u';
        alert('C√≥ l·ªói x·∫£y ra khi l∆∞u c√¢u h·ªèi!');
      }
    }

    function clearForm() {
      document.getElementById('questionForm').reset();
    }

    function clearBulkForm() {
      document.getElementById('bulkQuestionForm').reset();
    }

    function showSingleMode() {
      document.getElementById('questionForm').classList.remove('hidden');
      document.getElementById('bulkQuestionForm').classList.add('hidden');
      document.getElementById('deleteQuestionMode').classList.add('hidden');
      document.getElementById('btnSingleMode').style.background = '#667eea';
      document.getElementById('btnBulkMode').style.background = '#9ca3af';
      document.getElementById('btnDeleteMode').style.background = '#e74c3c';
    }

    function showBulkMode() {
      document.getElementById('questionForm').classList.add('hidden');
      document.getElementById('bulkQuestionForm').classList.remove('hidden');
      document.getElementById('deleteQuestionMode').classList.add('hidden');
      document.getElementById('btnSingleMode').style.background = '#9ca3af';
      document.getElementById('btnBulkMode').style.background = '#667eea';
      document.getElementById('btnDeleteMode').style.background = '#e74c3c';
    }

    function showDeleteMode() {
      document.getElementById('questionForm').classList.add('hidden');
      document.getElementById('bulkQuestionForm').classList.add('hidden');
      document.getElementById('deleteQuestionMode').classList.remove('hidden');
      document.getElementById('btnSingleMode').style.background = '#9ca3af';
      document.getElementById('btnBulkMode').style.background = '#9ca3af';
      document.getElementById('btnDeleteMode').style.background = '#667eea';
      
      loadQuestionsForDelete();
    }

    async function loadQuestionsForDelete() {
      await loadQuestionsFromDB();
      
      const container = document.getElementById('questionListContainer');
      container.innerHTML = '';
      
      const subjectQuestions = allQuestions.filter(q => q.admin_id === currentAdminId && q.subject === selectedSubject);
      
      if (subjectQuestions.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Kh√¥ng c√≥ c√¢u h·ªèi n√†o.</p>';
        return;
      }
      
      subjectQuestions.forEach((question, index) => {
        const questionCard = document.createElement('div');
        questionCard.style.background = 'white';
        questionCard.style.padding = '15px';
        questionCard.style.marginBottom = '10px';
        questionCard.style.borderRadius = '8px';
        questionCard.style.border = '2px solid #e0e0e0';
        questionCard.style.cursor = 'pointer';
        questionCard.style.transition = 'all 0.3s';
        
        questionCard.onmouseover = () => {
          questionCard.style.borderColor = '#e74c3c';
          questionCard.style.background = '#fff5f5';
        };
        
        questionCard.onmouseout = () => {
          questionCard.style.borderColor = '#e0e0e0';
          questionCard.style.background = 'white';
        };
        
        questionCard.onclick = () => confirmDeleteQuestion(question);
        
        questionCard.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <strong style="color: #667eea;">C√¢u ${index + 1}:</strong> ${question.question}
              <div style="margin-top: 8px; font-size: 14px; color: #666;">
                <div>A. ${question.answer_a}</div>
                <div>B. ${question.answer_b}</div>
                <div>C. ${question.answer_c}</div>
                <div>D. ${question.answer_d}</div>
                <div style="margin-top: 5px; color: #27ae60;"><strong>ƒê√°p √°n ƒë√∫ng: ${question.correct_answer}</strong></div>
              </div>
            </div>
            <div style="color: #e74c3c; font-size: 24px; margin-left: 15px;">üóëÔ∏è</div>
          </div>
        `;
        
        container.appendChild(questionCard);
      });
    }

    async function confirmDeleteQuestion(question) {
      const container = document.getElementById('questionListContainer');
      
      const confirmDiv = document.createElement('div');
      confirmDiv.style.position = 'fixed';
      confirmDiv.style.top = '0';
      confirmDiv.style.left = '0';
      confirmDiv.style.width = '100%';
      confirmDiv.style.height = '100%';
      confirmDiv.style.background = 'rgba(0, 0, 0, 0.5)';
      confirmDiv.style.display = 'flex';
      confirmDiv.style.alignItems = 'center';
      confirmDiv.style.justifyContent = 'center';
      confirmDiv.style.zIndex = '1000';
      
      const confirmBox = document.createElement('div');
      confirmBox.style.background = 'white';
      confirmBox.style.padding = '30px';
      confirmBox.style.borderRadius = '12px';
      confirmBox.style.maxWidth = '500px';
      confirmBox.style.boxShadow = '0 8px 16px rgba(0, 0, 0, 0.3)';
      
      confirmBox.innerHTML = `
        <h3 style="margin: 0 0 15px 0; color: #e74c3c;">‚ö†Ô∏è X√°c nh·∫≠n x√≥a c√¢u h·ªèi</h3>
        <p style="margin: 0 0 20px 0; color: #333;"><strong>${question.question}</strong></p>
        <div style="display: flex; gap: 10px;">
          <button id="confirmDeleteBtn" class="btn btn-secondary" style="flex: 1; border: none;">X√≥a</button>
          <button id="cancelDeleteBtn" class="btn" style="flex: 1; border: none;">H·ªßy</button>
        </div>
      `;
      
      confirmDiv.appendChild(confirmBox);
      document.body.appendChild(confirmDiv);
      
      document.getElementById('cancelDeleteBtn').onclick = () => {
        document.body.removeChild(confirmDiv);
      };
      
      document.getElementById('confirmDeleteBtn').onclick = async () => {
        const deleteBtn = document.getElementById('confirmDeleteBtn');
        deleteBtn.disabled = true;
        deleteBtn.textContent = 'ƒêang x√≥a...';
        
        try {
          // Delete from Trickle Database
          await trickleDeleteObject('question', question.id);
          
          document.body.removeChild(confirmDiv);
          await loadQuestionsForDelete();
          await updateSubjectCounts();
          
          const successDiv = document.createElement('div');
          successDiv.style.background = '#d4edda';
          successDiv.style.color = '#155724';
          successDiv.style.padding = '15px';
          successDiv.style.borderRadius = '8px';
          successDiv.style.marginBottom = '15px';
          successDiv.textContent = 'C√¢u h·ªèi ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!';
          
          container.insertBefore(successDiv, container.firstChild);
          setTimeout(() => successDiv.remove(), 3000);
        } catch (error) {
          console.error('Error deleting question:', error);
          deleteBtn.disabled = false;
          deleteBtn.textContent = 'X√≥a';
          alert('C√≥ l·ªói x·∫£y ra khi x√≥a c√¢u h·ªèi!');
        }
      };
    }

    async function saveBulkQuestions(event) {
      event.preventDefault();
      
      const submitButton = event.target.querySelector('button[type="submit"]');
      submitButton.disabled = true;
      submitButton.textContent = 'ƒêang x·ª≠ l√Ω...';
      
      const bulkText = document.getElementById('bulkQuestionText').value;
      const lines = bulkText.split('\n').map(line => line.trim()).filter(line => line.length > 0);
      
      const questions = [];
      let currentQuestion = null;
      let answers = {};
      let correctAnswer = null;
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        const answerMatch = line.match(/^([A-D])\.\s*=?\s*(.+)$/i);
        
        if (answerMatch) {
          const answerLetter = answerMatch[1].toUpperCase();
          let answerText = answerMatch[2].trim();
          
          if (line.match(/^[A-D]\.\s*=/i)) {
            correctAnswer = answerLetter;
          }
          
          answers[answerLetter] = answerText;
          
          if (Object.keys(answers).length === 4) {
            if (currentQuestion && correctAnswer) {
              questions.push({
                question: currentQuestion,
                answer_a: answers['A'] || '',
                answer_b: answers['B'] || '',
                answer_c: answers['C'] || '',
                answer_d: answers['D'] || '',
                correct_answer: correctAnswer
              });
            }
            
            currentQuestion = null;
            answers = {};
            correctAnswer = null;
          }
        } else {
          if (currentQuestion && Object.keys(answers).length > 0) {
            if (Object.keys(answers).length === 4 && correctAnswer) {
              questions.push({
                question: currentQuestion,
                answer_a: answers['A'] || '',
                answer_b: answers['B'] || '',
                answer_c: answers['C'] || '',
                answer_d: answers['D'] || '',
                correct_answer: correctAnswer
              });
            }
            answers = {};
            correctAnswer = null;
          }
          currentQuestion = line;
        }
      }
      
      if (currentQuestion && Object.keys(answers).length === 4 && correctAnswer) {
        questions.push({
          question: currentQuestion,
          answer_a: answers['A'] || '',
          answer_b: answers['B'] || '',
          answer_c: answers['C'] || '',
          answer_d: answers['D'] || '',
          correct_answer: correctAnswer
        });
      }
      
      if (questions.length === 0) {
        const errorDiv = document.createElement('div');
        errorDiv.style.background = '#f8d7da';
        errorDiv.style.color = '#721c24';
        errorDiv.style.padding = '15px';
        errorDiv.style.borderRadius = '8px';
        errorDiv.style.marginTop = '10px';
        errorDiv.textContent = 'Kh√¥ng t√¨m th·∫•y c√¢u h·ªèi h·ª£p l·ªá! Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng.';
        
        const form = document.getElementById('bulkQuestionForm');
        const existingError = form.querySelector('div[style*="background"]');
        if (existingError) existingError.remove();
        form.appendChild(errorDiv);
        
        submitButton.disabled = false;
        submitButton.textContent = 'L∆∞u t·∫•t c·∫£';
        return;
      }
      
      const currentSubjectQuestions = allQuestions.filter(q => q.admin_id === currentAdminId && q.subject === selectedSubject).length;
      if (currentSubjectQuestions + questions.length > 999) {
        const errorDiv = document.createElement('div');
        errorDiv.style.background = '#f8d7da';
        errorDiv.style.color = '#721c24';
        errorDiv.style.padding = '15px';
        errorDiv.style.borderRadius = '8px';
        errorDiv.style.marginTop = '10px';
        errorDiv.textContent = `Kh√¥ng th·ªÉ th√™m ${questions.length} c√¢u h·ªèi. Gi·ªõi h·∫°n 999 c√¢u cho m√¥n n√†y!`;
        
        const form = document.getElementById('bulkQuestionForm');
        const existingError = form.querySelector('div[style*="background"]');
        if (existingError) existingError.remove();
        form.appendChild(errorDiv);
        
        submitButton.disabled = false;
        submitButton.textContent = 'L∆∞u t·∫•t c·∫£';
        return;
      }
      
      try {
        // Save all questions to Trickle Database
        for (const q of questions) {
          const questionData = {
            admin_id: currentAdminId,
            subject: selectedSubject,
            question: q.question,
            answer_a: q.answer_a,
            answer_b: q.answer_b,
            answer_c: q.answer_c,
            answer_d: q.answer_d,
            correct_answer: q.correct_answer
          };
          
          await trickleCreateObject('question', questionData);
        }
        
        submitButton.disabled = false;
        submitButton.textContent = 'L∆∞u t·∫•t c·∫£';
        
        const messageDiv = document.createElement('div');
        messageDiv.style.padding = '15px';
        messageDiv.style.borderRadius = '8px';
        messageDiv.style.marginTop = '10px';
        messageDiv.style.background = '#d4edda';
        messageDiv.style.color = '#155724';
        messageDiv.textContent = `ƒê√£ l∆∞u th√†nh c√¥ng ${questions.length} c√¢u h·ªèi!`;
        
        const form = document.getElementById('bulkQuestionForm');
        const existingMessage = form.querySelector('div[style*="background"]');
        if (existingMessage) existingMessage.remove();
        form.appendChild(messageDiv);
        
        clearBulkForm();
        await updateSubjectCounts();
        setTimeout(() => messageDiv.remove(), 5000);
      } catch (error) {
        console.error('Error saving bulk questions:', error);
        submitButton.disabled = false;
        submitButton.textContent = 'L∆∞u t·∫•t c·∫£';
        alert('C√≥ l·ªói x·∫£y ra khi l∆∞u c√¢u h·ªèi!');
      }
    }

    function logout() {
      currentUser = null;
      currentAdminId = null;
      isAdmin = false;
      isMainAdmin = false;
      selectedSubject = null;
      clearInterval(timerInterval);
      
      document.getElementById('mainAdminLogin').classList.remove('hidden');
      document.getElementById('subAdminSelection').classList.add('hidden');
      document.getElementById('subAdminLoginForm').classList.add('hidden');
      
      showScreen('studentLoginScreen');
    }

    function showScreen(screenId) {
      const screens = ['studentLoginScreen', 'adminLoginScreen', 'studentDashboard', 'adminDashboard', 'examScreen', 'resultScreen'];
      screens.forEach(screen => {
        document.getElementById(screen).classList.add('hidden');
      });
      document.getElementById(screenId).classList.remove('hidden');
    }

    window.addEventListener('DOMContentLoaded', async () => {
      // Load data from Trickle Database
      await loadQuestionsFromDB();
      await loadPermissionsFromDB();
      
      // Apply default configuration on page load
      onConfigChange(defaultConfig);
    });
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ac849e790f2ddbe',t:'MTc2NTQ5MDc4MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
